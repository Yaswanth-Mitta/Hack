name: Build & Push Images

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Backend Linter (non-blocking)
      - name: Run Python linter (flake8)
        run: |
          pip install flake8 || true
          flake8 backend || echo "Linter warnings/errors ignored..."

      # Frontend Linter (non-blocking)
      - name: Run frontend linter (eslint)
        run: |
          npm install -g eslint || true
          cd frontend
          eslint . || echo "Frontend lint issues ignored..."

      # Backend Tests
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Run backend tests
        run: |
          cd backend
          pip install -r requirements.txt || true
          pytest || echo "Backend tests failed but continuing..."

      # Frontend Tests
      - name: Run frontend tests
        run: |
          cd frontend
          echo "Running dummy frontend tests..."
          if grep -q "<html" index.html; then
            echo "Frontend test passed!"
          else
            echo "Frontend test failed but continuing..."
          fi


      # SCA (Disabled)
      - name: SCA scan (disabled)
        run: |
          echo "SCA scan is intentionally disabled..."

      # Docker Login
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build & Push Backend image
      - name: Build & Push Backend image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/backend:${{ github.sha }} ./backend
          docker tag ${{ secrets.DOCKER_USERNAME }}/backend:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/backend:latest 
          # docker push ${{ secrets.DOCKER_USERNAME }}/backend:${{ github.sha }}
          docker push ${{ secrets.DOCKER_USERNAME }}/backend:latest

      # Build & Push Frontend image
      - name: Build & Push Frontend image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frontend:${{ github.sha }} ./frontend
          docker tag ${{ secrets.DOCKER_USERNAME }}/frontend:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/frontend:latest
          # docker push ${{ secrets.DOCKER_USERNAME }}/frontend:${{ github.sha }}
          docker push ${{ secrets.DOCKER_USERNAME }}/frontend:latest

